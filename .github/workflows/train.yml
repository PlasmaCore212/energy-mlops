name: Train Model

on:
  workflow_dispatch:
    inputs:
      cleanup_compute:
        description: 'Delete compute after training?'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      force_retrain:
        description: 'Force retrain even if model exists?'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: read
  actions: write

env:
  AZURE_SUBSCRIPTION_ID: 74e84083-a87b-4a82-b1f6-56e4fd7a9031
  AZURE_RESOURCE_GROUP: rg-energy-mlops
  AZURE_WORKSPACE_NAME: ml-energy-prediction
  AZURE_COMPUTE_NAME: cpu-cluster
  DATASET_NAME: household-power-consumption
  DATASET_VERSION: '1'

jobs:
  check-model:
    name: Check for Existing Model
    runs-on: ubuntu-latest
    outputs:
      model_exists: ${{ steps.check.outputs.exists }}
      model_version: ${{ steps.check.outputs.version }}
      should_train: ${{ steps.check.outputs.should_train }}
    
    steps:
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Check Model Registry
      id: check
      run: |
        MODEL_VERSION=$(az ml model list \
          --name energy-consumption-model \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --workspace-name ${{ env.AZURE_WORKSPACE_NAME }} \
          --query "[0].version" -o tsv 2>/dev/null || echo "")
        
        if [ -n "$MODEL_VERSION" ] && [ "$MODEL_VERSION" != "null" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "version=$MODEL_VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Found existing model version: $MODEL_VERSION"
          
          if [ "${{ github.event.inputs.force_retrain }}" = "true" ]; then
            echo "should_train=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Force retrain enabled"
          else
            echo "should_train=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ Skipping training, using existing model"
          fi
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "should_train=true" >> $GITHUB_OUTPUT
          echo "âš ï¸ No model found, training required"
        fi

  train-model:
    name: Train Model in Azure ML
    needs: check-model
    if: needs.check-model.outputs.should_train == 'true'
    runs-on: ubuntu-latest
    outputs:
      model_version: ${{ steps.register.outputs.model_version }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install Azure ML SDK
      run: |
        pip install marshmallow==3.19.0
        pip install azure-ai-ml==1.11.0 azure-identity==1.15.0
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Setup Compute Cluster
      run: |
        chmod +x scripts/setup_compute.sh
        ./scripts/setup_compute.sh
    
    - name: Submit Training Pipeline
      id: submit
      run: |
        cd azure-ml
        python create_pipeline.py
        
        JOB_NAME=$(cat job_name.txt)
        echo "job_name=$JOB_NAME" >> $GITHUB_OUTPUT
        echo "âœ… Job submitted: $JOB_NAME"
    
    - name: Wait for Training Completion
      run: |
        JOB_NAME="${{ steps.submit.outputs.job_name }}"
        echo "â³ Waiting for job: $JOB_NAME"
        
        az ml job stream \
          --name $JOB_NAME \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --workspace-name ${{ env.AZURE_WORKSPACE_NAME }}
    
    - name: Check Job Status
      run: |
        JOB_NAME="${{ steps.submit.outputs.job_name }}"
        
        STATUS=$(az ml job show \
          --name $JOB_NAME \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --workspace-name ${{ env.AZURE_WORKSPACE_NAME }} \
          --query status -o tsv)
        
        echo "Job status: $STATUS"
        
        if [ "$STATUS" != "Completed" ]; then
          echo "âŒ Training failed with status: $STATUS"
          exit 1
        fi
        
        echo "âœ… Training completed successfully"
    
    - name: Register Model
      id: register
      run: |
        JOB_NAME="${{ steps.submit.outputs.job_name }}"
        
        LATEST_VERSION=$(az ml model list \
          --name energy-consumption-model \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --workspace-name ${{ env.AZURE_WORKSPACE_NAME }} \
          --query "[0].version" -o tsv 2>/dev/null || echo "0")
        
        if [ -z "$LATEST_VERSION" ] || [ "$LATEST_VERSION" = "null" ]; then
          NEXT_VERSION=1
        else
          NEXT_VERSION=$((LATEST_VERSION + 1))
        fi
        
        echo "Registering model as version $NEXT_VERSION..."
        az ml model create \
          --name energy-consumption-model \
          --version $NEXT_VERSION \
          --path "azureml://jobs/$JOB_NAME/outputs/model_output" \
          --type custom_model \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --workspace-name ${{ env.AZURE_WORKSPACE_NAME }}
        
        if ! [[ "$NEXT_VERSION" =~ ^[0-9]+$ ]]; then
          echo "âŒ Invalid model version: '$NEXT_VERSION'"
          exit 1
        fi
        
        echo "model_version=$NEXT_VERSION" >> $GITHUB_OUTPUT
        echo "âœ… Model registered as version $NEXT_VERSION"
    
    - name: Cleanup Compute
      if: always() && github.event.inputs.cleanup_compute == 'true'
      run: |
        chmod +x scripts/cleanup_compute.sh
        ./scripts/cleanup_compute.sh
    
    - name: Training Summary
      run: |
        echo "## âœ… Training Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Job**: ${{ steps.submit.outputs.job_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Model Version**: ${{ steps.register.outputs.model_version }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Compute Cleaned Up**: ${{ github.event.inputs.cleanup_compute }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸš€ Deploy workflow will start automatically..." >> $GITHUB_STEP_SUMMARY

  trigger-deploy:
    name: Trigger Deployment
    needs: [check-model, train-model]
    if: always() && (needs.train-model.result == 'success' || (needs.check-model.outputs.model_exists == 'true' && needs.check-model.outputs.should_train == 'false'))
    runs-on: ubuntu-latest
    
    steps:
    - name: Determine Model Version
      id: version
      run: |
        if [ "${{ needs.train-model.result }}" = "success" ]; then
          echo "version=${{ needs.train-model.outputs.model_version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${{ needs.check-model.outputs.model_version }}" >> $GITHUB_OUTPUT
        fi
    
    - name: Trigger Deploy Workflow
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          await github.rest.actions.createWorkflowDispatch({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'deploy.yml',
            ref: 'main',
            inputs: {
              model_version: '${{ steps.version.outputs.version }}'
            }
          });
          console.log('âœ… Deploy workflow triggered with model version: ${{ steps.version.outputs.version }}');