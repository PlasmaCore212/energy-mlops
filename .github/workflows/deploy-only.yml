name: Build and Deploy (No Training)

on:
  push:
    branches: [ main ]
    paths:
      - 'api/**'
      - 'web/**'
      - 'k8s/**'
      - '.github/workflows/deploy-only.yml'
  workflow_dispatch:

env:
  ACR_NAME: arcenergy123

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Check Model Exists
      id: check
      run: |
        if [ -f "api/model/model.pkl" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "✅ Model found"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "⚠️ No model found - run train-and-deploy workflow first"
          exit 1
        fi
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Login to ACR
      run: |
        az acr login --name ${{ env.ACR_NAME }}
    
    - name: Build and Push Images
      run: |
        # API
        cd api
        docker build -t ${{ env.ACR_NAME }}.azurecr.io/energyapi:latest .
        docker push ${{ env.ACR_NAME }}.azurecr.io/energyapi:latest
        cd ..
        
        # Web
        cd web
        docker build -t ${{ env.ACR_NAME }}.azurecr.io/energy-web:latest .
        docker push ${{ env.ACR_NAME }}.azurecr.io/energy-web:latest
        
        echo "✅ Images rebuilt and pushed"