name: Deploy Application

on:
  workflow_dispatch:
    inputs:
      model_version:
        description: 'Model version to deploy'
        required: true
        type: string
  push:
    branches: [ main ]
    paths:
      - 'api/**'
      - 'web/**'
      - 'k8s/**'
      - '.github/workflows/deploy.yml'

env:
  AZURE_SUBSCRIPTION_ID: 74e84083-a87b-4a82-b1f6-56e4fd7a9031
  AZURE_RESOURCE_GROUP: rg-energy-mlops
  AZURE_WORKSPACE_NAME: ml-energy-prediction
  ACR_NAME: arcenergy123
  ACR_LOGIN_SERVER: arcenergy123-bgaycrdwf4gecpfv.azurecr.io

jobs:
  download-model:
    name: Download Model from Azure ML
    runs-on: ubuntu-latest
    if: github.event.inputs.model_version != '' || github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Download Model
      run: |
        if [ -n "${{ github.event.inputs.model_version }}" ]; then
          MODEL_VERSION="${{ github.event.inputs.model_version }}"
          echo "Using specified model version: $MODEL_VERSION"
          
          if ! [[ "$MODEL_VERSION" =~ ^[0-9]+$ ]]; then
            echo "❌ Invalid model version: '$MODEL_VERSION' (must be a positive integer)"
            exit 1
          fi
        else
          MODEL_VERSION=$(az ml model list \
            --name energy-consumption-model \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --workspace-name ${{ env.AZURE_WORKSPACE_NAME }} \
            --query "[0].version" -o tsv)
          
          if [ -z "$MODEL_VERSION" ] || [ "$MODEL_VERSION" = "null" ]; then
            echo "❌ No models found in registry"
            exit 1
          fi
          
          if ! [[ "$MODEL_VERSION" =~ ^[0-9]+$ ]]; then
            echo "❌ Invalid model version retrieved: '$MODEL_VERSION'"
            exit 1
          fi
          
          echo "Using latest model version: $MODEL_VERSION"
        fi
        
        mkdir -p api/model
        
        echo "Downloading model version $MODEL_VERSION..."
        az ml model download \
          --name energy-consumption-model \
          --version $MODEL_VERSION \
          --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
          --workspace-name ${{ env.AZURE_WORKSPACE_NAME }} \
          --download-path api/model
        
        # Move files from subdirectory to expected location
        echo "Reorganizing model files..."
        if [ -d "api/model/energy-consumption-model/model_output" ]; then
          mv api/model/energy-consumption-model/model_output/* api/model/
          rm -rf api/model/energy-consumption-model
        fi
        
        echo "✅ Model v$MODEL_VERSION downloaded"
        ls -lh api/model/
    
    - name: Upload Model Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: trained-model
        path: api/model/
        retention-days: 7

  build-and-push:
    name: Build and Push Docker Images
    needs: download-model
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Download Model
      uses: actions/download-artifact@v4
      with:
        name: trained-model
        path: api/model/
    
    - name: Verify Model
      run: |
        Write-Host "Model files:"
        Get-ChildItem api/model/
        
        if (-not (Test-Path "api/model/model.pkl")) {
          Write-Host "ERROR: model.pkl not found!"
          exit 1
        }
        
        Write-Host "Model verified successfully"
      shell: powershell
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Login to ACR
      run: |
        az acr login --name arcenergy123
      shell: powershell
    
    - name: Build and Push API Image
      working-directory: ./api
      run: |
        docker build `
          -t ${{ env.ACR_LOGIN_SERVER }}/energyapi:latest `
          -t ${{ env.ACR_LOGIN_SERVER }}/energyapi:${{ github.sha }} .
        
        docker push ${{ env.ACR_LOGIN_SERVER }}/energyapi:latest
        docker push ${{ env.ACR_LOGIN_SERVER }}/energyapi:${{ github.sha }}
        
        Write-Host "API image pushed successfully"
      shell: powershell
    
    - name: Build and Push Web Image
      working-directory: ./web
      run: |
        docker build `
          -t ${{ env.ACR_LOGIN_SERVER }}/energy-web:latest `
          -t ${{ env.ACR_LOGIN_SERVER }}/energy-web:${{ github.sha }} .
        
        docker push ${{ env.ACR_LOGIN_SERVER }}/energy-web:latest
        docker push ${{ env.ACR_LOGIN_SERVER }}/energy-web:${{ github.sha }}
        
        Write-Host "Web image pushed successfully"
      shell: powershell

  deploy-to-kubernetes:
    name: Deploy to Local Kubernetes
    needs: build-and-push
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to Kubernetes
      run: |
        $ACR_NAME = "${{ env.ACR_NAME }}"
        $ACR_LOGIN_SERVER = "${{ env.ACR_LOGIN_SERVER }}"
        
        # Get ACR credentials
        $ACR_USERNAME = az acr credential show --name $ACR_NAME --query username -o tsv
        $ACR_PASSWORD = az acr credential show --name $ACR_NAME --query "passwords[0].value" -o tsv
        
        # Apply namespace
        kubectl apply -f k8s/namespace.yaml
        
        # Create/update ACR secret
        kubectl create secret docker-registry acr-secret `
          --namespace energy-mlops `
          --docker-server="$ACR_LOGIN_SERVER" `
          --docker-username=$ACR_USERNAME `
          --docker-password=$ACR_PASSWORD `
          --dry-run=client -o yaml | kubectl apply -f -
        
        # Deploy all resources
        kubectl apply -f k8s/
        
        # Wait for rollout
        kubectl rollout status deployment/energy-prediction-api -n energy-mlops --timeout=300s
        kubectl rollout status deployment/energy-web -n energy-mlops --timeout=300s
      shell: powershell
    
    - name: Deployment Status
      run: |
        Write-Host "`nDEPLOYMENT COMPLETE!`n"
        
        kubectl get pods -n energy-mlops
        kubectl get svc -n energy-mlops
        
        Write-Host "`nAccess:"
        Write-Host "  API:  http://localhost:30080/docs"
        Write-Host "  Web:  http://localhost:30081"
      shell: powershell
    
    - name: Deployment Summary
      run: |
        echo "## Deployment Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Docker Images:" >> $GITHUB_STEP_SUMMARY
        echo "- \`${{ env.ACR_LOGIN_SERVER }}/energyapi:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`${{ env.ACR_LOGIN_SERVER }}/energy-web:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Access:" >> $GITHUB_STEP_SUMMARY
        echo "- API: http://localhost:30080/docs" >> $GITHUB_STEP_SUMMARY
        echo "- Web: http://localhost:30081" >> $GITHUB_STEP_SUMMARY